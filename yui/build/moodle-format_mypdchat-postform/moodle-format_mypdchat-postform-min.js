YUI.add("moodle-format_mypdchat-postform",function(e,t){M.format_mypdchat=M.format_mypdchat||{},M.format_mypdchat.postforminit=function(t){"use strict";function s(t,n,r){var s=M.cfg.wwwroot+"/course/format/mypdchat/ajax.php",o=M.util.add_spinner(e,n),u={method:"POST",on:{start:function(){o.show()},success:function(t,n){try{var i=e.JSON.parse(n.responseText);i.error==0?r(i):alert(i.error),o.hide()}catch(s){alert("parsefailed"),o.hide()}},failure:function(){i=!1,o.hide()}}};t.data&&(u.data=t.data),t.form&&(u.form=t.form),e.io(s,u)}function o(e){var n={};n.courseid=t.courseid,n.action="likepost",n.postid=e.get("id").split("_")[1],n.userlike=Number(e.hasClass("like")),n.sesskey=M.cfg.sesskey,s({data:n},e,function(e){u(e)})}function u(t){var n=e.one("#userlike_"+t.postid);t.userlike=="1"?(n.replaceClass("like","likenomore"),n.setHTML(M.str.format_mypdchat.likenomore)):(n.replaceClass("likenomore","like"),n.setHTML(M.str.format_mypdchat.like)),p(t)}function a(){var e={};e.courseid=t.courseid,e.action="loadmoreposts",e.sesskey=M.cfg.sesskey,e.limitfrom=t.postsloaded,s({data:e},r,function(e){f(e)})}function f(n){var s=e.Node.create(n.postshtml);r.insert(s,"before"),t.postsloaded=n.postsloaded,t.poststotal=n.poststotal;var o=M.str.format_mypdchat.counttotalpost.replace("{$a->count}",t.postsloaded).replace("{$a->total}",t.poststotal);e.one("#counttotalpost").setHTML(o),i=!1}function l(e){var n={};n.courseid=t.courseid,n.action="lockpost",n.sesskey=M.cfg.sesskey,n.postid=e.get("id").split("_")[1],n.locked=Number(!e.hasClass("locked")),s({data:n},e,function(e){c(e)})}function c(t){var n=e.one("#showcommentform_"+t.postid+"_0"),r=e.one("#lockpost_"+t.postid),i=r.one("*");t.locked=="1"?(n.hide(),e.one("#tlcommentformwrap_"+t.postid+"_0").hide(),r.replaceClass("unlocked","locked"),i.set("src",M.util.image_url("lockedpost","format_mypdchat"))):(n.show(),r.replaceClass("locked","unlocked"),M.util.image_url("unlockedpost","format_mypdchat"),i.set("src",M.util.image_url("unlockedpost","format_mypdchat")))}function h(t){var n=t.get("id").split("_")[1],r=t.get("id").split("_")[2],i=e.one("#commenttext_"+n+"_"+r).get("value");if(!i)return alert(M.str.format_mypdchat.textrequired),!1;var o={id:"tlcommentform_"+n+"_"+r,useDisabled:!0};s({form:o},t,function(e){d(e)})}function p(t){var n=e.one("#tlcountcomments_"+t.postid);n&&n.setHTML(M.str.format_mypdchat.countcomments.replace("{$a}",t.countcomments));var r=e.one("#tlcountlikes_"+t.postid);r&&r.setHTML(M.str.format_mypdchat.countlikes.replace("{$a}",t.countlikes))}function d(t){var n=t.postid+"_"+t.replycommentid;e.one("#commenttext_"+n).set("value",""),e.one("#tlcommentformwrap_"+n).hide();var r=e.Node.create(t.commenthtml);e.one("#tlcomments_"+n).prepend(r),p(t)}function v(e){var n={};n.courseid=t.courseid,n.action="showallcomments",n.sesskey=M.cfg.sesskey,n.postid=e.get("id").split("_")[1],s({data:n},e,function(e){m(e)})}function m(t){e.one("#tlcomments_"+t.postid+"_0").setHTML(t.commentshtml),e.one("#tlshowall_"+t.postid).hide()}function g(e){var n={};n.courseid=t.courseid,n.action="showallreplies",n.sesskey=M.cfg.sesskey,n.replycommentid=e.get("id").split("_")[1],s({data:n},e,function(e){y(e)})}function y(t){e.one("#tlcomments_"+t.postid+"_"+t.replycommentid).setHTML(t.replieshtml),e.one("#tlshowallreplies_"+t.replycommentid).hide()}function b(e){var n={};n.courseid=t.courseid,n.action="showalldiscussions",n.sesskey=M.cfg.sesskey,n.postid=e.get("id").split("_")[1],s({data:n},e,function(e){w(e)})}function w(t){var n=e.one("#tlcomments_"+t.postid+"_0");if(!n)return!1;e.one("#tlcomments_"+t.postid+"_0").setHTML(t.commentshtml);var r=e.one("#tlcomments_"+t.postid+"_0 .tl-showall");r&&r.hide();var i=e.one("#tlshowall_"+t.postid);return i&&e.one("#tlshowall_"+t.postid).hide(),!0}function E(e){var n={};n.courseid=t.courseid,n.action="deletecomment",n.sesskey=M.cfg.sesskey,n.cid=e.get("id").split("_")[1],s({data:n},e,function(e){x(e)})}function S(e){var t=new M.core.confirm({title:M.util.get_string("confirm","moodle"),question:M.util.get_string("confirmdeletecomment","format_mypdchat"),yesLabel:M.util.get_string("yes","moodle"),noLabel:M.util.get_string("cancel","moodle")});t.on("complete-yes",function(){t.hide(),t.destroy(),E(e)}),t.show()}function x(t){e.one("#tlcomment_"+t.commentid).remove(!0),p(t)}function T(){e.one("#externalurlwrapper").show(),n.hide();var t=e.one("#loadfilemanager");t&&t.set("value","0")}function N(){e.one("#externalurlwrapper").hide(),n.show();var t=e.one("#loadfilemanager");t&&t.set("value","1")}function C(){var t=e.one("#section-2"),n=e.one("#attachedrecentactivities");if(!t||!n)return!1;var r=[];t.all('li[id^="module-"]').each(function(e){r[r.length]=e.get("id").split("-")[1]}),n.all('label[for^="module_"]').each(function(e){r[r.length]=e.get("for").split("_")[1]});var i=r.join(",");return e.one("#cmsequence").set("value",i),!0}function k(){var e=window.innerHeight-(r.getY()-window.pageYOffset);!i&&e>50&&t.postsloaded<t.poststotal&&(i=!0,a())}function L(n){var r={};r.posttext=e.one("#posttext").get("value"),r.togroupid=e.one("#id_togroupid").get("value");var i=e.one("#id_poststatus");i?r.poststatus=i.get("value"):r.poststatus=0,r.postid=e.one("#id").get("value"),r.courseid=t.courseid,r.action="storeformparams",r.sesskey=M.cfg.sesskey;var s=M.cfg.wwwroot+"/course/format/mypdchat/ajax.php";e.io(s,{data:r,sync:n})}function A(){e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),l(e.currentTarget)},'a[id^="lockpost_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),o(e.target)},'a[id^="userlike_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),h(e.target)},'input[id^="postcomment_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),v(e.target)},'a[id^="tlshowall_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),g(e.target)},'a[id^="tlshowallreplies_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault
(),b(e.target)},'a[id^="tlshowalldiscussions_"]'),e.one("#tl-posts").delegate("click",function(e){e.preventDefault(),S(e.currentTarget)},'a[id^="tldeletecomment_"]'),e.one("#tl-posts").delegate("click",function(t){t.preventDefault();var n=t.target.get("id").split("_")[1],r=t.target.get("id").split("_")[2];e.one("#tlcommentformwrap_"+n+"_"+r).show()},'a[id^="showcommentform_"]');var t=e.one("#addalink");t&&t.on("click",function(e){e.preventDefault(),T()}),n=e.one("#fileswrapper"),n&&e.one("#uploadfile").on("click",function(e){e.preventDefault(),N()}),e.one("#id_submitbutton").on("click",function(){C()}),r=e.one("#tl-endofposts"),e.on("scroll",function(){k()}),window.onbeforeunload=null,e.all(".section-modchooser-link").on("click",function(){L(!1)});var i=e.one("#posttext");i&&i.on("change",function(){L(!1)});var s=e.one("#id_togroupid");s&&s.on("change",function(){L(!1)});var u=e.one("#id_poststatus");u&&u.on("change",function(){L(!1)})}var n,r,i=!1;A()}},"@VERSION@",{requires:["base","node","io-form","moodle-core-notification-confirm"]});
